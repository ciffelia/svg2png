<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>svg2png</title>
    <style>
      html {
        font-family: sans-serif;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
      }

      body {
        display: grid;
        place-items: center;
      }
    </style>
    <script type="module">
      const main = () => {
        document.body.addEventListener("dragenter", onDrag);
        document.body.addEventListener("dragover", onDrag);
        document.body.addEventListener("drop", onDrop);

        const fileInput = document.getElementById("file-input");
        fileInput.addEventListener("change", onFileChange);
      };

      const onDrag = (e) => {
        e.preventDefault();
        e.stopPropagation();

        e.dataTransfer.dropEffect = "copy";
      };

      const onDrop = async (e) => {
        e.preventDefault();
        e.stopPropagation();

        await handleFiles(e.dataTransfer.files);
      };

      const onFileChange = async (e) => {
        await handleFiles(e.target.files);

        // Reset so the same file can be selected twice in a row.
        e.target.value = "";
      };

      const handleFiles = async (files) => {
        for (const origFile of files) {
          const image = await fileToImage(origFile);

          const canvas = imageToCanvas(image);

          const blob = await canvasToBlob(canvas);

          const origFileName = origFile.name;
          const convertedFileName =
            origFileName.substring(0, origFileName.lastIndexOf(".")) + ".png";

          downloadBlob(blob, convertedFileName);
        }
      };

      const fileToImage = (file) =>
        new Promise((resolve, reject) => {
          const image = document.createElement("img");

          image.onload = () => {
            resolve(image);
          };
          image.onerror = (e) => {
            reject(new Error("Failed to load image"));
          };

          image.src = URL.createObjectURL(file);
        });

      const imageToCanvas = (image) => {
        const canvas = document.createElement("canvas");
        canvas.width = image.width;
        canvas.height = image.height;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(image, 0, 0, image.width, image.height);

        return canvas;
      };

      const canvasToBlob = (canvas, mimeType, qualityArgument) =>
        new Promise((resolve, reject) => {
          try {
            canvas.toBlob(resolve, mimeType, qualityArgument);
          } catch (e) {
            reject(e);
          }
        });

      const downloadBlob = (blob, fileName) => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = fileName;

        a.click();
      };

      main();
    </script>
  </head>
  <body>
    <input id="file-input" type="file" accept="image/*" multiple />
  </body>
</html>
